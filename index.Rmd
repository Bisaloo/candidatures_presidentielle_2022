---
title: "Parrainages et candidatures à l'élection présidentielle 2022"
description: Mis à jour le `r format(lubridate::today(), '%d/%m/%Y')`
site: distill::distill_website
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

# Learn more about creating websites with Distill at:
# https://rstudio.github.io/distill/website.html


```

```{r, fig.height = 5}
library(tidyverse)

parrainages_csv <- "https://presidentielle2022.conseil-constitutionnel.fr/telechargement/parrainagestotal.csv"
date_premier_tour <- as.Date('2022-04-10')

ajd <- lubridate::today()

d <- read_csv2(parrainages_csv) %>%
  mutate(Candidat = fct_lump_min(Candidat, 10)) %>%
  filter(Candidat != "Other") %>%
  mutate(Candidat = fct_drop(Candidat)) %>%
  mutate(Candidat = fct_infreq(Candidat))

candidats <- d %>%
  pull(Candidat) %>%
  levels() %>%
  str_replace("(.+) ([^[:space:]]+)", "\\2 \\1")

headshots <- candidats %>%
  stringi::stri_trans_general("ASCII") %>%
  str_to_lower() %>%
  str_replace_all(" ", "_") %>%
  str_replace_all("-", "_")

headshots_url <- headshots %>%
  { paste0('https://www.francetvinfo.fr/docs/desk3/candidat-tracker/2021_10_11_', ., '.png') }

# Manually fix inconsistent naming scheme...
headshots_url <- str_replace(headshots_url, "jean_luc_melenchon", "jean_luc-melenchon")
headshots_url <- str_replace(headshots_url, "2021_10_11_christiane_taubira", "2021_12_17_christiane_taubira")
headshots_url <- str_replace(headshots_url, "2021_10_11_gaspard_koenig", "2022_01_11_gaspard_koenig")

mapply(download.file, headshots_url, glue::glue("img/{headshots}.png", quiet = TRUE))

d %>%
  ggplot(aes(y = fct_rev(Candidat), fill = fct_rev(`Date de publication`))) +
    geom_histogram(stat = "count") +
    scale_fill_brewer(palette = "Greens", direction = -1) +
    geom_vline(xintercept = 500, colour = "darkred") +
    theme_minimal() +
    theme(
      legend.position = "bottom",
      axis.text.y = ggtext::element_markdown()
    ) +
    labs(
      x = "Nombre de parrainages",
      y = "",
      fill = "Date du parrainage",
      title = "Quel·le·s candidat·e·s à l'élection présidentielle\nont reçu leurs 500 parrainages ?",
      subtitle = glue::glue("Source des données: https://presidentielle2022.conseil-constitutionnel.fr\nMis à jour le {format(ajd, '%d/%m/%Y')} (J-{date_premier_tour - ajd} avant le premier tour)\nSource des images: franceinfo"),
      caption = "Pour des questions de lisibilité, seul·le·s candidat·e·s avec plus de 10 parrainages sont présent·e·s sur ce graphique"
    ) +
    annotate(
      geom = "curve", x = 550, y = 10, xend = 501, yend = 10,
      curvature = -.3, arrow = arrow(length = unit(2, "mm")),
      colour = "darkred"
    ) +
    annotate(
      geom = "text", x = 550, y = 10,
      label = "Nombre de parrainages requis\npour participer à l'élection",
      hjust = "left", colour = "darkred") +
    scale_y_discrete(labels = glue::glue("{rev(candidats)} <img src='img/{rev(headshots)}.png' width='10'>")) +
   NULL
```
